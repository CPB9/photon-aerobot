module zcvm

import clk::{TimePoint, Duration}
import powerfan::{Reg}
import powerfanproxy::{BldcId}

enum Slaves {
    PowerCom,
    PowerFan1,
    PowerFan2,
}

struct SlaveRunningState {
    #[ranges(default=1, min=1, max=1)]
    powerCom: bool,
    #[ranges(default=1, min=1, max=1)]
    powerFan1: bool,
    #[ranges(default=1, min=1, max=1)]
    powerFan2: bool,
    powerComLastTime: TimePoint,
    powerFan1LastTime: TimePoint,
    powerFan2LastTime: TimePoint,    
}

component {
    variables {
        slavesState: SlaveRunningState
    }

    statuses {
        [slaveState, 1, true]: {slavesState.powerCom, slavesState.powerFan1, slavesState.powerFan2}
        [slaveLastTimes, 1, false]: {slavesState.powerComLastTime, slavesState.powerFan1LastTime, slavesState.powerFan2LastTime}
    }
    
    events {
        [slaveConnectionChanged, true]: {state: SlaveRunningState},
        [restoreBldcReg, true]: {bldc: BldcId, reg: Reg, value: u8},
    }
    
    impl {
        fn init()
        fn tick()
        fn updateSlaveMessageTime(slave: Slaves)
    }
    
    commands {
    }
}
